---
title: "Dataset GSE17891"
output:
  html_document:
    toc: yes
    toc_float: yes
    theme: flatly
    highlight: kate
    code_folding: hide
  pdf_document:
    toc: yes
editor_options:
  
  chunk_output_type: console
---

```{r include=FALSE}
# Id
ID <- "GSE17891"
#
carpeta <- paste0("./RESULTATS_",ID)
dir.create(carpeta)

# DIRECTORIS LINIA

linia <- paste0(carpeta, "/", "LINIA")
dir.create(linia)

resultatsplots_l <- paste0(linia,"/","PLOTS")
resultatstaules_l <- paste0(linia,"/","TAULES")
resultatsobjectes_l <- paste0(linia,"/","OBJECTES_R")

dir.create(resultatsplots_l)
dir.create(resultatstaules_l)
dir.create(resultatsobjectes_l)

# DATATABLE

datatable_jm<-function(x,column=NULL){
datatable(
  x,
  extensions = 'Buttons',
  filter = list(position = 'top', clear = T),
  options = list(dom = 'Blfrtip',
                 scrollX = TRUE, scrollCollapse = TRUE,
                 # buttons = list(list(extend = 'colvis')),
                 buttons = list(list(extend = 'colvis'),'copy', 'print',
                                list(extend = 'collection',
                                     buttons = c('csv', 'excel', 'pdf'),
                                     text = 'Download')),
                 columnDefs = list(list(visible=FALSE, targets=column))))}

```

```{r include=FALSE}
## Global options
source("/usr/local/lib/R/site-library/AnalisisArrays2/templates/llibreries_Informes.R")
knitr::opts_chunk$set(warning = F,message = F,class.source = "watch-out")

library(oligo)
library(DT)
library(clusterProfiler)
library(genefilter)
library(dplyr)
library(rrvgo)

```


```{r eval=FALSE}
# Differential expression analysis with limma
library(GEOquery)
library(limma)
library(umap)

# load series and platform data from GEO

gset <- getGEO("GSE17891", GSEMatrix =TRUE, AnnotGPL=TRUE)

## check how many platforms used

## if more than one dataset is present, you can analyse the other dataset by changing the number inside the [[...]]
head(gset[[1]]@phenoData@data)

gset<-gset[[1]]

save(gset, file= paste0(carpeta,"/gset"))

png("./RESULTATS_GSE17891/boxplot.png")
boxplot(gset,las=2)
dev.off()

```

Aquesta base de dades conté resultats obtinguts de teixit i linia cel·lular. 
No és possible dur a terme l'anàlisi conjunt, es realitza per separat
```{r}
knitr::include_graphics("./RESULTATS_GSE17891/boxplot.png", dpi = 100)
```


# 2. Anàlisi linia cel·lular


```{r echo=TRUE}
load(file = paste0(carpeta, "/gset"))

gset <- gset[,grep("line",gset@phenoData@data$characteristics_ch1)]
save(gset, file= paste0(resultatsobjectes_l,"/gset"))

```

# Normalització
Aquestes dades ja es troben normalitzades. 
No s'aplica cap normalització.

# Expressió de PLAC8
```{r}
matriu_exprs <- exprs(gset) 

boxplot(gset,las=2)

```

# Expressió diferencial grups (high/low expression PLAC8)
Es realitza l'expressió diferencial en funció de la mediana o els quartils Q1 i Q4 de l'expressió de PLAC8 

## Median 
```{r}
library(clusterProfiler)
library(genefilter)
library(dplyr)
library(limma)

median <- median(matriu_exprs[gset@featureData@data$ID[gset@featureData@data$`Gene symbol`=="PLAC8"],])
# gset@featureData@data$ID[gset@featureData@data$`Gene symbol`=="PLAC8"]


gset@phenoData@data$gmedian <-
unlist(as.list(exprs(gset[gset@featureData@data$ID=="219014_at",])>median))

## Control vs Caso

# table(gset@phenoData@data$gmedian)
groups = gset@phenoData@data$gmedian
groups<-gsub("FALSE","LOW",groups)
groups<-gsub("TRUE","HIGH",groups)
groups<-as.factor(groups)

design = model.matrix(~ 0 + groups)
colnames(design)<-gsub("groups","",colnames(design))

data.fit = lmFit(matriu_exprs,design)

contrast.matrix = makeContrasts(LOW-HIGH,levels=design)
data.fit.con = contrasts.fit(data.fit,contrast.matrix)
data.fit.eb = eBayes(data.fit.con)

table_DEG_median <- topTable(data.fit.eb, number = Inf,adjust.method = "fdr",genelist = gset@featureData@data)

table_DEG_sig_median <- table_DEG_median %>%
                   filter(adj.P.Val<=0.05)


save(table_DEG_median, file= paste0(resultatstaules_l, "/table_DEG_median"))
save(table_DEG_sig_median, file= paste0(resultatstaules_l, "/table_DEG_sig_median"))

```

No hi ha gens diferencialment expressats que siguin signigicatius entre els dos grups (en funció de  median)
```{r}
dim(table_DEG_sig_median)
```


### GO_GSEA
No hi ha cap terme enriquit
```{r eval=FALSE}
load(paste0(resultatstaules_l, "/table_DEG_median"))

# GO GSEA

library(org.Hs.eg.db)
library(clusterProfiler)

table_DEG_complete<-
  table_DEG_median[table_DEG_median$Gene.ID!="",]

table_DEG_complete<-
table_DEG_complete %>% group_by(Gene.ID) %>% 
  filter(adj.P.Val==min(adj.P.Val))
geneList<-table_DEG_complete$logFC
names(geneList)<-table_DEG_complete$Gene.ID

save(table_DEG_complete, file = paste0(resultatstaules_l, "/table_DEG_complete"))

geneList<-geneList[order(geneList, decreasing = TRUE)]

set.seed(123)
GO_gsea <- gseGO(geneList     = geneList,
              OrgDb        = org.Hs.eg.db,
              ont          = "BP",
                # minGSSize    = 100,
                # maxGSSize    = 500,
              pvalueCutoff = 0.05,
              verbose      = T
              )

# GO_gsea
GO_gsea <- setReadable(GO_gsea, OrgDb = org.Hs.eg.db, keyType="ENTREZID")
save(GO_gsea,file = paste0(resultatsobjectes_l, "/GO_gsea"))
```


### KEGG GSEA
```{r}
load(paste0(resultatstaules_l, "/table_DEG_median"))
load(paste0(resultatstaules_l, "/table_DEG_complete"))

geneList<-table_DEG_complete$logFC
names(geneList)<-table_DEG_complete$Gene.ID

geneList<-geneList[order(geneList, decreasing = TRUE)]
set.seed(123)
kegg_gsea <- gseKEGG(geneList     = geneList,
               organism     = 'hsa',
               # minGSSize    = 120,
               pvalueCutoff = 0.05,
               verbose      = FALSE
               )

kegg_gsea <- setReadable(kegg_gsea, OrgDb = org.Hs.eg.db, keyType="ENTREZID")

save(kegg_gsea,file = paste0(resultatsobjectes_l, "/kegg_gsea_median"))
```


```{r}
load(paste0(resultatsobjectes_l, "/kegg_gsea_median"))
load(paste0(resultatstaules_l, "/table_DEG_median"))
load(paste0(resultatstaules_l, "/table_DEG_complete"))

kegg_gsea_df<-kegg_gsea@result
kegg_gsea_df<-kegg_gsea@result %>%
  filter(p.adjust<=0.25) 

num_gens<-unlist(lapply(kegg_gsea_df$core_enrichment, function(x) sum(table_DEG_complete$Gene.symbol%in%strsplit(x ,"/")[[1]]) ))
name_gens<-unlist(lapply(kegg_gsea_df$core_enrichment, function(x) paste(table_DEG_complete$Gene.symbol[(table_DEG_complete$Gene.symbol%in%strsplit(x,"/")[[1]])],collapse = "/") ))

kegg_gsea_df$num_gens<-num_gens
kegg_gsea_df$name_gens<-name_gens

kegg_gsea_df <-
kegg_gsea_df %>% 
  mutate(NES_cat=ifelse(NES<0,"Down","Up"))

kegg_gsea_df_p<-kegg_gsea_df %>%
  group_by(NES_cat) %>% 
  arrange(pvalue) %>%  
  slice_head(n=20)

kegg_graph <- kegg_gsea_df_p %>% group_by(NES_cat) %>%
    slice_head(n=10) %>% 
    ggplot(aes(x = NES, y = fct_reorder(Description, NES))) + 
  geom_segment(aes(yend = Description,colour = p.adjust), xend = 0, size=3) +
  geom_point(aes(color = p.adjust),size = 5) +
    theme_bw(base_size = 15) +
  theme(text = element_text(size=12))+
    # scale_colour_gradient(limits=c(0, pvalue), low="red") +
    ylab(NULL)+
    # ggtitle(paste0("First ",num_GO, " up & ", num_GO," down regulated specific GO"))+
    facet_grid(.~NES_cat,scales = "free")+
  scale_colour_continuous(low = "#f29191",
                         high = "#4ca4fc")


kegg_gsea_df_median <- kegg_gsea_df

save(kegg_gsea_df_median, file= paste0(resultatstaules_l, "/kegg_gsea_df_median"))

png(paste0(resultatsplots_l, "/kegg_graph_median.png"),width = 900,height = 600,res=100)
kegg_graph
dev.off()
```

```{r}
load(paste0(resultatstaules_l, "/kegg_gsea_df_median"))
datatable_jm(kegg_gsea_df_median, column = c("core_enrichment"))
```

```{r}
knitr::include_graphics(paste0(resultatsplots_l, "/kegg_graph_median.png"), dpi = 100)
```


### HALLMARKS amb entrez ID

```{r}
library(msigdbr)
library(fgsea)
```

```{r}
load(paste0(resultatstaules_l, "/table_DEG_complete"))

geneList<-table_DEG_complete$logFC
names(geneList)<-table_DEG_complete$Gene.ID

msigdbr_df <- msigdbr(species = "human", category = "H")

# fixing format to work with fgsea

pathwaysH = split(x = msigdbr_df$entrez_gene, f = msigdbr_df$gs_name)

# run fgsea enrichment
set.seed(123)
fgseaRes <- fgsea(pathways=pathwaysH, geneList)

fgseaRes <- fgseaRes %>% 
  filter(padj<=0.25)

fgseaRes$leadingEdge_1<-
unlist(lapply(fgseaRes$leadingEdge, function (x) paste0(x,collapse = ",")))

fgseaRes<- fgseaRes %>% 
  select(-leadingEdge)
```


```{r}
datatable_jm(fgseaRes)
```


```{r}
# Representació gràfica 

fgseaRes <-
fgseaRes %>% 
  mutate(NES_cat=ifelse(NES<0,"Down","Up"))
num<-20

fgseaRes_1 <- fgseaRes %>%
  group_by(NES_cat) %>% 
  arrange(pval) %>% 
  slice_head(n=20) %>% 
  group_by(pathway) %>% 
  
  mutate(pathway_mod=
           ifelse(length(strsplit(pathway, "")[[1]])>num,paste0(paste0((strsplit(pathway, ""))[[1]][1:num],collapse = ""), "..."),pathway))%>% 
   ungroup()%>% 
   arrange(pval) %>% 
  mutate(pathway_mod=paste0(row_number(),":",pathway_mod))

fgseaRes_graph <- fgseaRes_1 %>% 
    group_by(NES_cat) %>%
    slice_head(n=10) %>% 
    ggplot(aes(x = NES, y = fct_reorder(pathway_mod, NES))) + 
    geom_segment(aes(yend = pathway_mod,colour = pval), xend = 0, size=3) +
    geom_point(aes(color = pval),size = 5) +
    theme_bw(base_size = 15) +
    theme(text = element_text(size=12))+
    # scale_colour_gradient(limits=c(0, pvalue), low="red") +
    ylab(NULL)+
    facet_grid(.~NES_cat,scales = "free")+
  scale_colour_continuous(low = "#f29191",
                         high = "#4ca4fc")

fgseaRes_graph

save(fgseaRes, file=paste0(resultatstaules_l, "/hallmarks_median_linia_entrez_ID"))
write.csv(fgseaRes, file="./RESULTATS_GSE17891/TEIXIT/TAULES/hallmarks_median_teixit_entrez_ID.csv") 

png(paste0(resultatsplots_l, "/hallmarks_median_linia_graph_entrez_ID.png"),width = 900,height = 600,res=100)
fgseaRes_graph
dev.off()

```

### HALLMARKS amb Gene Symbol

```{r}
load(paste0(resultatstaules_l, "/table_DEG_complete"))

geneList<-table_DEG_complete$logFC
names(geneList)<-table_DEG_complete$Gene.symbol

msigdbr_df <- msigdbr(species = "human", category = "H")

# fixing format to work with fgsea

pathwaysH = split(x = msigdbr_df$gene_symbol, f = msigdbr_df$gs_name)

# run fgsea enrichment

set.seed(123)
fgseaRes <- fgsea(pathways=pathwaysH, geneList)

fgseaRes <- fgseaRes %>% 
  filter(padj<=0.25)

fgseaRes$leadingEdge_1<-
unlist(lapply(fgseaRes$leadingEdge, function (x) paste0(x,collapse = ",")))

fgseaRes<- fgseaRes %>% 
  select(-leadingEdge)
```

```{r}
datatable_jm(fgseaRes)
```


```{r}
# Representació gràfica 

fgseaRes <-
fgseaRes %>% 
  mutate(NES_cat=ifelse(NES<0,"Down","Up"))
num<-20

fgseaRes_1 <- fgseaRes %>%
  group_by(NES_cat) %>% 
  arrange(pval) %>% 
  slice_head(n=20) %>% 
  group_by(pathway) %>% 
  
  mutate(pathway_mod=
           ifelse(length(strsplit(pathway, "")[[1]])>num,paste0(paste0((strsplit(pathway, ""))[[1]][1:num],collapse = ""), "..."),pathway))%>% 
   ungroup()%>% 
   arrange(pval) %>% 
  mutate(pathway_mod=paste0(row_number(),":",pathway_mod))

fgseaRes_graph <- fgseaRes_1 %>% 
    group_by(NES_cat) %>%
    slice_head(n=10) %>% 
    ggplot(aes(x = NES, y = fct_reorder(pathway_mod, NES))) + 
    geom_segment(aes(yend = pathway_mod,colour = pval), xend = 0, size=3) +
    geom_point(aes(color = pval),size = 5) +
    theme_bw(base_size = 15) +
    theme(text = element_text(size=12))+
    # scale_colour_gradient(limits=c(0, pvalue), low="red") +
    ylab(NULL)+
    facet_grid(.~NES_cat,scales = "free")+
  scale_colour_continuous(low = "#f29191",
                         high = "#4ca4fc")

fgseaRes_graph

save(fgseaRes, file=paste0(resultatstaules_l, "/hallmarks_median_linia"))
write.csv(fgseaRes, file="./RESULTATS_GSE17891/TEIXIT/TAULES/hallmarks_median_teixit.csv") 

png(paste0(resultatsplots_l, "/hallmarks_median_linia_graph.png"),width = 900,height = 600,res=100)
fgseaRes_graph
dev.off()

```


### C2 subcategory CP:KEGG 
```{r}
# GeneList
geneList<-table_DEG_complete$logFC
names(geneList)<-table_DEG_complete$Gene.symbol
geneList<-geneList[order(geneList, decreasing = TRUE)]

msigdbr_df <- msigdbr(species = "human", category = "C2", subcategory = "CP:KEGG")

# fixing format to work with fgsea

pathwaysH = split(x = msigdbr_df$gene_symbol, f = msigdbr_df$gs_name)

# run fgsea enrichment

set.seed(123)
fgseaRes <- fgsea(pathways=pathwaysH, geneList)

# run fgsea enrichment

fgseaRes <- fgseaRes %>% 
  arrange(pval) %>% 
  filter(padj<=0.25)

fgseaRes$leadingEdge_1<-
unlist(lapply(fgseaRes$leadingEdge, function (x) paste0(x,collapse = ",")))

fgseaRes<- fgseaRes %>% 
  dplyr::select(-leadingEdge)


```

```{r}
datatable_jm(fgseaRes)
```

```{r}
# Representació gràfica 

fgseaRes <-
fgseaRes %>% 
  mutate(NES_cat=ifelse(NES<0,"Down","Up"))
num<-20

fgseaRes_1 <- fgseaRes %>%
  group_by(NES_cat) %>% 
  arrange(pval) %>% 
  slice_head(n=20) %>% 
  group_by(pathway) %>% 
  
  mutate(pathway_mod=
           ifelse(length(strsplit(pathway, "")[[1]])>num,paste0(paste0((strsplit(pathway, ""))[[1]][1:num],collapse = ""), "..."),pathway))%>% 
   ungroup()%>% 
   arrange(pval) %>% 
  mutate(pathway_mod=paste0(row_number(),":",pathway_mod))


fgseaRes_graph <- fgseaRes_1 %>% 
    group_by(NES_cat) %>%
    slice_head(n=10) %>% 
    ggplot(aes(x = NES, y = fct_reorder(pathway_mod, NES))) + 
    geom_segment(aes(yend = pathway_mod,colour = pval), xend = 0, size=3) +
    geom_point(aes(color = pval),size = 5) +
    theme_bw(base_size = 15) +
    theme(text = element_text(size=12))+
    # scale_colour_gradient(limits=c(0, pvalue), low="red") +
    ylab(NULL)+
    facet_grid(.~NES_cat,scales = "free")+
  scale_colour_continuous(low = "#f29191",
                         high = "#4ca4fc")

fgseaRes_graph

png(paste0(resultatsplots_l, "/C2_KEGG_median_graph.png"),width = 900,height = 600,res=100)
fgseaRes_graph
dev.off()

save(fgseaRes, file=paste0(resultatstaules_l, "/C2_KEGG_median"))
write.csv(fgseaRes, file=paste0(resultatstaules_l, "/C2_KEGG_median.csv")) 

```


### C2 subcategory CP:REACTOME

```{r}
# GeneList
geneList<-table_DEG_complete$logFC
names(geneList)<-table_DEG_complete$Gene.symbol
geneList<-geneList[order(geneList, decreasing = TRUE)]

msigdbr_df <- msigdbr(species = "human", category = "C2", subcategory = "CP:REACTOME")

# fixing format to work with fgsea

pathwaysH = split(x = msigdbr_df$gene_symbol, f = msigdbr_df$gs_name)

# run fgsea enrichment

set.seed(123)
fgseaRes <- fgsea(pathways=pathwaysH, geneList)

# run fgsea enrichment

fgseaRes <- fgseaRes %>% 
  filter(padj<=0.25)

fgseaRes$leadingEdge_1<-
unlist(lapply(fgseaRes$leadingEdge, function (x) paste0(x,collapse = ",")))

fgseaRes<- fgseaRes %>% 
  select(-leadingEdge)
```

```{r}
datatable_jm(fgseaRes)
```

```{r}
# Representació gràfica 

fgseaRes <-
fgseaRes %>% 
  mutate(NES_cat=ifelse(NES<0,"Down","Up"))

num<-25

fgseaRes_1 <- fgseaRes %>%
  group_by(NES_cat) %>% 
  arrange(pval) %>% 
  slice_head(n=20) %>% 
  group_by(pathway) %>% 
  
  mutate(pathway_mod=
           ifelse(length(strsplit(pathway, "")[[1]])>num,paste0(paste0((strsplit(pathway, ""))[[1]][1:num],collapse = ""), "..."),pathway))%>% 
   ungroup()%>% 
   arrange(pval) %>% 
  mutate(pathway_mod=paste0(row_number(),":",pathway_mod))

fgseaRes_graph <- fgseaRes_1 %>% 
    group_by(NES_cat) %>%
    slice_head(n=10) %>% 
    ggplot(aes(x = NES, y = fct_reorder(pathway_mod, NES))) + 
    geom_segment(aes(yend = pathway_mod,colour = pval), xend = 0, size=3) +
    geom_point(aes(color = pval),size = 5) +
    theme_bw(base_size = 15) +
    theme(text = element_text(size=12))+
    # scale_colour_gradient(limits=c(0, pvalue), low="red") +
    ylab(NULL)+
    facet_grid(.~NES_cat,scales = "free")+
  scale_colour_continuous(low = "#f29191",
                         high = "#4ca4fc")

fgseaRes_graph

png(paste0(resultatsplots_l, "/C2_REACTOME_median_graph.png"),width = 900,height = 600,res=100)
fgseaRes_graph
dev.off()

save(fgseaRes, file=paste0(resultatstaules_l, "/C2_REACTOME_median"))
write.csv(fgseaRes, file=paste0(resultatstaules_l, "/C2_REACTOME_median.csv")) 

```

### C6: ONCOGENIC SIGNATURE 
```{r}
# GeneList
geneList<-table_DEG_complete$logFC
names(geneList)<-table_DEG_complete$Gene.symbol
geneList<-geneList[order(geneList, decreasing = TRUE)]

msigdbr_df <- msigdbr(species = "human", category = "C6")

# fixing format to work with fgsea

pathwaysH = split(x = msigdbr_df$gene_symbol, f = msigdbr_df$gs_name)

# run fgsea enrichment

set.seed(123)
fgseaRes <- fgsea(pathways=pathwaysH, geneList)

# run fgsea enrichment

fgseaRes <- fgseaRes %>% 
  filter(padj<=0.25)

fgseaRes$leadingEdge_1<-
unlist(lapply(fgseaRes$leadingEdge, function (x) paste0(x,collapse = ",")))

fgseaRes<- fgseaRes %>% 
  select(-leadingEdge)

```

```{r}
datatable_jm(fgseaRes)
```

```{r}
# Representació gràfica 

fgseaRes <-
fgseaRes %>% 
  mutate(NES_cat=ifelse(NES<0,"Down","Up"))

num<-20

fgseaRes_1 <- fgseaRes %>%
  group_by(NES_cat) %>% 
  arrange(pval) %>% 
  slice_head(n=20) %>% 
  group_by(pathway) %>% 
  
  mutate(pathway_mod=
           ifelse(length(strsplit(pathway, "")[[1]])>num,paste0(paste0((strsplit(pathway, ""))[[1]][1:num],collapse = ""), "..."),pathway))%>% 
   ungroup()%>% 
   arrange(pval) %>% 
  mutate(pathway_mod=paste0(row_number(),":",pathway_mod))

fgseaRes_graph <- fgseaRes_1 %>% 
    group_by(NES_cat) %>%
    slice_head(n=10) %>% 
    ggplot(aes(x = NES, y = fct_reorder(pathway_mod, NES))) + 
    geom_segment(aes(yend = pathway_mod,colour = pval), xend = 0, size=3) +
    geom_point(aes(color = pval),size = 5) +
    theme_bw(base_size = 15) +
    theme(text = element_text(size=12))+
    # scale_colour_gradient(limits=c(0, pvalue), low="red") +
    ylab(NULL)+
    facet_grid(.~NES_cat,scales = "free")+
  scale_colour_continuous(low = "#f29191",
                         high = "#4ca4fc")

fgseaRes_graph


png(paste0(resultatsplots_l, "/C6_oncogenic_median_graph.png"),width = 900,height = 600,res=100)
fgseaRes_graph
dev.off()

save(fgseaRes, file=paste0(resultatstaules_l, "/C6_oncogenic_median"))
write.csv(fgseaRes, file=paste0(resultatstaules_l, "/C6_oncogenic_median.csv")) 

```

### C7: IMMUNOGENIC SIGNATURE 
```{r}
# GeneList
geneList<-table_DEG_complete$logFC
names(geneList)<-table_DEG_complete$Gene.symbol
geneList<-geneList[order(geneList, decreasing = TRUE)]

msigdbr_df <- msigdbr(species = "human", category = "C7")

# fixing format to work with fgsea

pathwaysH = split(x = msigdbr_df$gene_symbol, f = msigdbr_df$gs_name)

# run fgsea enrichment

set.seed(123)
fgseaRes <- fgsea(pathways=pathwaysH, geneList)

# run fgsea enrichment

fgseaRes <- fgseaRes %>% 
  filter(padj<=0.25)

fgseaRes$leadingEdge_1<-
unlist(lapply(fgseaRes$leadingEdge, function (x) paste0(x,collapse = ",")))

fgseaRes<- fgseaRes %>% 
  select(-leadingEdge)
```

```{r}
datatable_jm(fgseaRes)
```

```{r}
# Representació gràfica 

fgseaRes <-
fgseaRes %>% 
  mutate(NES_cat=ifelse(NES<0,"Down","Up"))

num<-20

fgseaRes_1 <- fgseaRes %>%
  group_by(NES_cat) %>% 
  arrange(pval) %>% 
  slice_head(n=20) %>% 
  group_by(pathway) %>% 
  
  mutate(pathway_mod=
           ifelse(length(strsplit(pathway, "")[[1]])>num,paste0(paste0((strsplit(pathway, ""))[[1]][1:num],collapse = ""), "..."),pathway))%>% 
   ungroup()%>% 
   arrange(pval) %>% 
  mutate(pathway_mod=paste0(row_number(),":",pathway_mod))

fgseaRes_graph <- fgseaRes_1 %>% 
    group_by(NES_cat) %>%
    slice_head(n=10) %>% 
    ggplot(aes(x = NES, y = fct_reorder(pathway_mod, NES))) + 
    geom_segment(aes(yend = pathway_mod,colour = pval), xend = 0, size=3) +
    geom_point(aes(color = pval),size = 5) +
    theme_bw(base_size = 15) +
    theme(text = element_text(size=12))+
    # scale_colour_gradient(limits=c(0, pvalue), low="red") +
    ylab(NULL)+
    facet_grid(.~NES_cat,scales = "free")+
  scale_colour_continuous(low = "#f29191",
                         high = "#4ca4fc")

fgseaRes_graph

png(paste0(resultatsplots_l, "/C7_IMMUNOGENIC_median_graph.png"),width = 900,height = 600,res=100)
fgseaRes_graph
dev.off()

save(fgseaRes, file=paste0(resultatstaules_l, "/C7_IMMUNOGENIC_median"))
write.csv(fgseaRes, file=paste0(resultatstaules_l, "/C7_IMMUNOGENIC_median.csv")) 

```


## Correlació PLAC8 amb diferents sets de gens
### Molecular subtyping
```{r}
# Molecular subtyping (set of genes):
genes_mol_sub <- c("GATA6", "CDH1","HNF4A", "FOXA1", "KT5", "FAT2", "S100A2", "VIM", "PTHLH", "P63")

# Correlacionar gen PLAC8 amb els gens anteriors:

# matriu_exprs[gset@featureData@data$ID[gset@featureData@data$`Gene symbol`=="PLAC8"]]
# table(gset@featureData@data$`Gene symbol`==genes_mol_sub[6])
# gset@featureData@data$ID[gset@featureData@data$`Gene symbol`==genes_mol_sub[9]]

# Falten gens KT5 i P63

# "GATA6"= "210002_at" "229282_at"
# "CDH1"=  "201130_s_at" "201131_s_at"
# "HNF4A"=  "208429_x_at" "214832_at"   "214851_at"   "216889_s_at" "230772_at"   "230914_at"  
# "FOXA1"="204667_at" "237086_at"
# "FAT2" "208153_s_at"
# "S100A2","204268_at"
# "VIM", "1555938_x_at" "201426_s_at" 
# "PTHLH", "206300_s_at" "210355_at"   "211756_at"  

sondes_mol_sub <- c("210002_at", "229282_at", "201130_s_at", "201131_s_at", "208429_x_at", "214832_at", "214851_at",   "216889_s_at", "230772_at", "230914_at","204667_at", "237086_at", "208153_s_at", "204268_at","1555938_x_at", "201426_s_at","206300_s_at", "210355_at", "211756_at")

# cortest<- cor.test(matriu_exprs[rownames(matriu_exprs)=="ILMN_1653026"], matriu_exprs[gset_norm@featureData@data$ID==sondes_mol_sub[2]])

# S'haurà de fer amb sondes.... més d'una sonda per gen!!! com en el set GSE36924

taula_cor_test <-matrix(nrow=length(sondes_mol_sub), ncol = 2)
i=1
for (i in 1:length(sondes_mol_sub)) {
  gen_in_matrix <- sum(gset@featureData@data$ID==sondes_mol_sub[i])
 if(gen_in_matrix>0){
  matriu_plac <-matriu_exprs[gset@featureData@data$`Gene symbol`=="PLAC8",]

  matriu_2 <-matriu_exprs[
  gset@featureData@data$ID==sondes_mol_sub[i],]          

cortest <- cor.test(matriu_plac,matriu_2)
taula_cor_test[i,1]<-cortest$estimate
taula_cor_test[i,2]<-cortest$p.value
row.names(taula_cor_test)<- sondes_mol_sub
row.names(taula_cor_test)<- gset@featureData@data$`Gene symbol`[match(row.names(taula_cor_test), gset@featureData@data$ID)]
colnames(taula_cor_test)<- c("cor", "pvalue")
}}

```

Taula de correlacions gen PLAC8 amb els diferents gens del set Molecular subtyping.
Els gens que es troben repetits fa referència a que hi ha més d'una sonda que codifica pel mateix gen
```{r}
datatable_jm(taula_cor_test)

```

### Stemness genes
```{r}
# Stemness genes (set of genes):
# Abca1, Plod2, Abcg1, c-Kit, Cd133, Lrg5, 
genes_stemness <- c("ABCA1", "PLOD2","ABCG1", "cKIT", "CD133", "LRG5")

# Correlacionar gen PLAC8 amb els gens anteriors:
# matriu_exprs[gset_norm@featureData@data$ID[gset_norm@featureData@data$`Gene symbol`=="PLAC8"]]
# matriu_exprs[gset_norm@featureData@data$ID=="ILMN_1653026"]

# table(gset_norm@featureData@data$`Gene symbol`==genes_stemness[1])
# "c-KIT", "CD133", "LRG5" no hi son

# gset@featureData@data$ID[gset@featureData@data$`Gene symbol`==genes_stemness[6]]

# "ABCA1""1570279_at"  "203504_s_at" "203505_at"   "216066_at"  
# "PLOD2""202619_s_at" "202620_s_at"
# "ABCG1""204567_s_at" "211113_s_at" "230913_at"   "232081_at"  

sondes_stemness <- c("1570279_at", "203504_s_at", "203505_at", "216066_at", "202619_s_at", "202620_s_at","204567_s_at", "211113_s_at", "230913_at", "232081_at")

taula_cor_test <-matrix(nrow=length(sondes_stemness), ncol = 2)
i=1
for (i in 1:length(sondes_stemness)) {
  gen_in_matrix <- sum(gset@featureData@data$ID==sondes_stemness[i])
 if(gen_in_matrix>0){
  matriu_plac <-matriu_exprs[gset@featureData@data$`Gene symbol`=="PLAC8",]

  matriu_2 <-matriu_exprs[
  gset@featureData@data$ID==sondes_stemness[i],]          

cortest <- cor.test(matriu_plac,matriu_2)
taula_cor_test[i,1]<-cortest$estimate
taula_cor_test[i,2]<-cortest$p.value
row.names(taula_cor_test)<- sondes_stemness
row.names(taula_cor_test)<- gset@featureData@data$`Gene symbol`[match(row.names(taula_cor_test), gset@featureData@data$ID)]
colnames(taula_cor_test)<- c("cor", "pvalue")
}}

```

Taula de correlacions gen PLAC8 amb els diferents gens del geneset Stemness.
Els gens que es troben repetits fa referència a que hi ha més d'una sonda que codifica pel mateix gen
```{r}
datatable_jm(taula_cor_test)
```

### EMT genes
```{r}
# EMT genes (set of genes):
genes_emt <- c("CDH1", "SNAI2", "TWIST1", "LRRC1", "PDPN", "OCLN", "KRT8", "KRT18", "HAS2") 

# Correlacionar gen PLAC8 amb els gens anteriors:
  # matriu_exprs[gset_norm@featureData@data$ID=="ILMN_1653026"]

# table(gset_norm@featureData@data$`Gene symbol`==genes_emt[1])
# gset@featureData@data$ID[gset@featureData@data$`Gene symbol`==genes_emt[9]]

# Relació gene symbol i sondes
# "CDH1""201130_s_at" "201131_s_at"
# "SNAI2" "213139_at"
# "TWIST1""213943_at"
# "LRRC1""207790_at" "218816_at"
# "PDPN""204879_at" "208233_at" "221898_at" "226658_at"
# "OCLN""209925_at" "227492_at" "231022_at" "235937_at"
# "KRT8" "209008_x_at"
# "KRT18""201596_x_at"
# "HAS2""206432_at" "230372_at"

# Creació de variable amb les sondes d'interés
sondes_emt <- c("201130_s_at", "201131_s_at", "213139_at","213943_at", "207790_at", "218816_at","204879_at", "208233_at", "221898_at", "226658_at", "209925_at", "227492_at", "231022_at", "235937_at","209008_x_at", "201596_x_at", "206432_at", "230372_at")

# Taula de correlacions gen PLAC8 amb els diferents gens del gene set emt
taula_cor_test <-matrix(nrow=length(sondes_emt), ncol = 2)
i=1
for (i in 1:length(sondes_emt)) {
  gen_in_matrix <- sum(gset@featureData@data$ID==sondes_emt[i])
 if(gen_in_matrix>0){
  matriu_plac <-matriu_exprs[gset@featureData@data$`Gene symbol`=="PLAC8",]

  matriu_2 <-matriu_exprs[
  gset@featureData@data$ID==sondes_emt[i],]          

cortest <- cor.test(matriu_plac,matriu_2)
taula_cor_test[i,1]<-cortest$estimate
taula_cor_test[i,2]<-cortest$p.value
row.names(taula_cor_test)<- sondes_emt
row.names(taula_cor_test)<- gset@featureData@data$`Gene symbol`[match(row.names(taula_cor_test), gset@featureData@data$ID)]
colnames(taula_cor_test)<- c("cor", "pvalue")
}}

```

Taula de correlacions gen PLAC8 amb els diferents gens del geneset EMT.
Els gens que es troben repetits fa referència a que hi ha més d'una sonda que codifica pel mateix gen
```{r}
datatable_jm(taula_cor_test)
```





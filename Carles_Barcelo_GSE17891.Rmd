---
title: "Dataset GSE17891"
output:
  html_document:
    toc: yes
    toc_float: yes
    theme: flatly
    highlight: kate
    code_folding: hide
  pdf_document:
    toc: yes
editor_options:
  
  chunk_output_type: console
---

```{r include=FALSE}
# Id
ID <- "GSE17891"
#
carpeta <- paste0("./RESULTATS_",ID)
dir.create(carpeta)

# DIRECTORIS TEIXIT
teixit <- paste0(carpeta, "/", "TEIXIT")
dir.create(teixit)

resultatsplots_t <- paste0(teixit,"/","PLOTS")
resultatstaules_t <- paste0(teixit,"/","TAULES")
resultatsobjectes_t <- paste0(teixit,"/","OBJECTES_R")

dir.create(resultatsplots_t)
dir.create(resultatstaules_t)
dir.create(resultatsobjectes_t)

# DIRECTORIS LINIA

linia <- paste0(carpeta, "/", "LINIA")
dir.create(linia)

resultatsplots_l <- paste0(linia,"/","PLOTS")
resultatstaules_l <- paste0(linia,"/","TAULES")
resultatsobjectes_l <- paste0(linia,"/","OBJECTES_R")

dir.create(resultatsplots_l)
dir.create(resultatstaules_l)
dir.create(resultatsobjectes_l)

# dir.create(paste0("./RESULTATS_GSE17891/",linia))
# dir.create(paste0(carpeta,"/",linia,"/PLOTS"))
# dir.create(paste0(carpeta,"/",linia,"/TAULES"))
# dir.create(paste0(carpeta,"/",linia,"/OBJECTES_R"))


# DATATABLE

datatable_jm<-function(x,column=NULL){
datatable(
  x,
  extensions = 'Buttons',
  filter = list(position = 'top', clear = T),
  options = list(dom = 'Blfrtip',
                 scrollX = TRUE, scrollCollapse = TRUE,
                 # buttons = list(list(extend = 'colvis')),
                 buttons = list(list(extend = 'colvis'),'copy', 'print',
                                list(extend = 'collection',
                                     buttons = c('csv', 'excel', 'pdf'),
                                     text = 'Download')),
                 columnDefs = list(list(visible=FALSE, targets=column))))}

```

```{r include=FALSE}
## Global options
source("/usr/local/lib/R/site-library/AnalisisArrays2/templates/llibreries_Informes.R")
knitr::opts_chunk$set(warning = F,message = F,class.source = "watch-out")

library(oligo)
library(DT)
library(clusterProfiler)
library(genefilter)
library(dplyr)
library(rrvgo)

```


```{r eval=FALSE}
# Differential expression analysis with limma
library(GEOquery)
library(limma)
library(umap)

# load series and platform data from GEO

gset <- getGEO("GSE17891", GSEMatrix =TRUE, AnnotGPL=TRUE)

## check how many platforms used
length(gset)
## if more than one dataset is present, you can analyse the other dataset by changing the number inside the [[...]]
head(gset[[1]]@phenoData@data)

gset<-gset[[1]]

save(gset, file= paste0(carpeta,"/gset"))

png("./RESULTATS_GSE17891/boxplot.png")
boxplot(gset,las=2)
dev.off()
# boxplot(gset,las=2)
```

Aquesta base de dades conté resultats obtinguts de teixit i linia cel·lular. 
No és possible dur a terme l'anàlisi conjunt, es realitza per separat
```{r}
knitr::include_graphics("./RESULTATS_GSE17891/boxplot.png", dpi = 100)
```


# 1. Anàlisi teixit

```{r echo=TRUE}
load(file = paste0(carpeta,"/gset"))

gset<-gset[,gset@phenoData@data$characteristics_ch1=="tissue: ductal adenocarcinoma tumor"]
save(gset, file= paste0(resultatsobjectes_t,"/gset"))

# sum(grepl("PLAC8",gset@featureData@data$`Gene symbol`,ignore.case = T))
# gset@featureData@data$`Gene symbol`[(grep("PLAC8",gset@featureData@data$`Gene symbol`,ignore.case = T))]
  
# table(gset@featureData@data$`Gene symbol`[(grep("PLAC8",gset@featureData@data$`Gene symbol`,ignore.case = T))])
  
# gset@featureData@data$`Gene symbol`=="PLAC8"
# grep("PLAC8",gset@featureData@data$`Gene symbol`,ignore.case = T)
# datatable(gset@featureData@data[28299,])

```

# Normalització
Aquestes dades ja es troben normalitzades. 
No s'aplica cap normalització.
```{r eval=FALSE, include=TRUE}
# library(affyPLM)
# gset_norm<-normalize.ExpressionSet.quantiles(gset, transfn="none")
```

# Expressió de PLAC8
```{r}
matriu_exprs <- exprs(gset) 
# boxplot(gset,las=2)
median <- median(matriu_exprs[gset@featureData@data$ID[gset@featureData@data$`Gene symbol`=="PLAC8"],])

```

```{r}
load(paste0(resultatsobjectes_t,"/gset"))
boxplot(gset, las=2)
```

# Expressió diferencial grups (high/low expression PLAC8)
Es realitza l'expressió diferencial en funció de la mediana o els quartils Q1 i Q4 de l'expressió de PLAC8 

## Median 
```{r}
library(clusterProfiler)
library(genefilter)
library(dplyr)
library(limma)

# gset@featureData@data$ID[gset@featureData@data$`Gene symbol`=="PLAC8"]

gset@phenoData@data$gmedian <-
unlist(as.list(exprs(gset[gset@featureData@data$ID=="219014_at",])>median))

## Control vs Caso

# table(gset@phenoData@data$gmedian)
groups = gset@phenoData@data$gmedian
groups<-gsub("FALSE","LOW",groups)
groups<-gsub("TRUE","HIGH",groups)
groups<-as.factor(groups)

design = model.matrix(~ 0 + groups)
colnames(design)<-gsub("groups","",colnames(design))

data.fit = lmFit(matriu_exprs,design)

contrast.matrix = makeContrasts(LOW-HIGH,levels=design)
data.fit.con = contrasts.fit(data.fit,contrast.matrix)
data.fit.eb = eBayes(data.fit.con)

table_DEG_median <- topTable(data.fit.eb, number = Inf,adjust.method = "fdr",genelist = gset@featureData@data)

# dim(table_DEG_median)

table_DEG_sig_median <- table_DEG_median %>%
                   filter(adj.P.Val<=0.05)

dim(table_DEG_sig_median)

save(table_DEG_median, file=paste0(resultatstaules_t,"/table_DEG_median"))
save(table_DEG_sig_median, file=paste0(resultatstaules_t,"/table_DEG_sig_median"))
   
```

Gen PLAC8 únic gen diferencialment expressat significatiu en teixit (en funció de la median)
```{r}
load(paste0(resultatstaules_t,"/table_DEG_sig_median"))
datatable_jm(table_DEG_sig_median,column = c("GO.Process", "GO.Function","GO.Process.ID", "GO.Function.ID"))

```


### GO_GSEA
```{r}
load(paste0(resultatstaules_t,"/table_DEG_median"))
load(paste0(resultatstaules_t,"/table_DEG_sig_median"))

# GO GSEA

library(org.Hs.eg.db)
library(clusterProfiler)

table_DEG_complete<-
  table_DEG_median[table_DEG_median$Gene.ID!="",]

table_DEG_complete<-
table_DEG_complete %>% group_by(Gene.ID) %>% 
  filter(adj.P.Val==min(adj.P.Val))
geneList<-table_DEG_complete$logFC
names(geneList)<-table_DEG_complete$Gene.ID

geneList<-geneList[order(geneList, decreasing = TRUE)]

set.seed(123)
GO_gsea <- gseGO(geneList     = geneList,
              OrgDb        = org.Hs.eg.db,
              ont          = "BP",
                # minGSSize    = 100,
                # maxGSSize    = 500,
              pvalueCutoff = 0.05,
              verbose      = T
              )

# GO_gsea
GO_gsea <- setReadable(GO_gsea, OrgDb = org.Hs.eg.db, keyType="ENTREZID")
save(GO_gsea, file= paste0(resultatsobjectes_t,"/GO_gsea"))
```


```{r}
load(paste0(resultatsobjectes_t, "/GO_gsea"))
load(paste0(resultatstaules_t,"/table_DEG_median"))
load(paste0(resultatstaules_t,"/table_DEG_sig_median"))

# reducedTerms

GO_gsea_df<-GO_gsea@result
GO_gsea_df<-GO_gsea@result %>%
  filter(p.adjust<=0.05)

table_DEG_complete<-
  table_DEG_median[table_DEG_median$Gene.ID!="",]


num_gens <-unlist(lapply(GO_gsea_df$core_enrichment, function(x) sum(table_DEG_complete$symbol%in%strsplit(x ,"/")[[1]]) ))
name_gens <-unlist(lapply(GO_gsea_df$core_enrichment, function(x) paste(table_DEG_complete$symbol[(table_DEG_complete$symbol%in%strsplit(x,"/")[[1]])],collapse = "/") ))

GO_gsea_df$num_gens<-num_gens
GO_gsea_df$name_gens<-name_gens

library(rrvgo)

simMatrix <- calculateSimMatrix(GO_gsea_df$ID,
                                orgdb="org.Hs.eg.db",
                                ont="BP",
                                method="Rel")

scores <- setNames(-log10(GO_gsea_df$qvalue), GO_gsea_df$ID)

reducedTerms_median <- reduceSimMatrix(simMatrix,
                                scores,
                                threshold=0.7,
                                orgdb="org.Hs.eg.db")

png(paste0(resultatsplots_t, "/treemapplot_median.png"),width = 900,height = 600,res=100)
treemapPlot(reducedTerms_median)
dev.off()
```

```{r}
knitr::include_graphics(paste0(resultatsplots_t, "/treemapplot_median.png"), dpi = 100)
```

### KEGG GSEA
```{r eval=FALSE}
geneList<-table_DEG_complete$logFC
names(geneList)<-table_DEG_complete$Gene.ID

geneList<-geneList[order(geneList, decreasing = TRUE)]
set.seed(123)
kegg_gsea <- gseKEGG(geneList     = geneList,
               organism     = 'hsa',
               # minGSSize    = 120,
               pvalueCutoff = 0.05,
               verbose      = FALSE
               )

kegg_gsea <- setReadable(kegg_gsea, OrgDb = org.Hs.eg.db, keyType="ENTREZID")

save(kegg_gsea,file = paste0(resultatsobjectes_t, "/kegg_gsea_median")) 
```

```{r}
load(paste0(resultatsobjectes_t, "/kegg_gsea_median"))

kegg_gsea_df<-kegg_gsea@result
kegg_gsea_df<-kegg_gsea@result %>%
  filter(p.adjust<=0.05) 

num_gens<-unlist(lapply(kegg_gsea_df$core_enrichment, function(x) sum(table_DEG_complete$Gene.symbol%in%strsplit(x ,"/")[[1]]) ))
name_gens<-unlist(lapply(kegg_gsea_df$core_enrichment, function(x) paste(table_DEG_complete$Gene.symbol[(table_DEG_complete$Gene.symbol%in%strsplit(x,"/")[[1]])],collapse = "/") ))

kegg_gsea_df$num_gens<-num_gens
kegg_gsea_df$name_gens<-name_gens

kegg_gsea_df <-
kegg_gsea_df %>% 
  mutate(NES_cat=ifelse(NES<0,"Down","Up"))

kegg_gsea_df_p<-kegg_gsea_df %>%
  arrange(NES) %>% 
  slice_head(n=20)

kegg_graph <- kegg_gsea_df_p %>% group_by(NES_cat) %>%
    slice_head(n=10) %>% 
    ggplot(aes(x = NES, y = fct_reorder(Description, NES))) + 
  geom_segment(aes(yend = Description,colour = p.adjust), xend = 0, size=3) +
  geom_point(aes(color = p.adjust),size = 5) +
    theme_bw(base_size = 15) +
  theme(text = element_text(size=12))+
    # scale_colour_gradient(limits=c(0, pvalue), low="red") +
    ylab(NULL)+
    # ggtitle(paste0("First ",num_GO, " up & ", num_GO," down regulated specific GO"))+
    facet_grid(.~NES_cat,scales = "free")+
  scale_colour_continuous(low = "#f29191",
                         high = "#4ca4fc")

kegg_gsea_df_median <- kegg_gsea_df

save(kegg_gsea_df_median, file= paste0(resultatstaules_t, "/kegg_gsea_df_median"))

png(paste0(resultatsplots_t, "/kegg_graph_median.png"),width = 900,height = 600,res=100)
kegg_gsea_df_p %>% group_by(NES_cat) %>%
    slice_head(n=10) %>% 
    ggplot(aes(x = NES, y = fct_reorder(Description, NES))) + 
  geom_segment(aes(yend = Description,colour = p.adjust), xend = 0, size=3) +
  geom_point(aes(color = p.adjust),size = 5) +
    theme_bw(base_size = 15) +
  theme(text = element_text(size=12))+
    # scale_colour_gradient(limits=c(0, pvalue), low="red") +
    ylab(NULL)+
    # ggtitle(paste0("First ",num_GO, " up & ", num_GO," down regulated specific GO"))+
    facet_grid(.~NES_cat,scales = "free")+
  scale_colour_continuous(low = "#f29191",
                         high = "#4ca4fc")

dev.off()
```

```{r}
load(paste0(resultatstaules_t, "/kegg_gsea_df_median"))
datatable_jm(kegg_gsea_df_median, column = c("core_enrichment"))
```

```{r}
knitr::include_graphics(paste0(resultatsplots_t, "/kegg_graph_median.png"), dpi = 100)
```

### HALLMARKS

```{r}
library(msigdbr)
library(fgsea)

```

```{r}
msigdbr_df <- msigdbr(species = "human", category = "H")

# fixing format to work with fgsea

pathwaysH = split(x = msigdbr_df$entrez_gene, f = msigdbr_df$gs_name)

# run fgsea enrichment
length(pathwaysH)
pathwaysH[1]
fgseaRes <- fgsea(pathways=pathwaysH, geneList)
data.frame(fgseaRes)

```




```{r}
msigdbr_df <- msigdbr(species = "human", category = "H")

# fixing format to work with fgsea

pathwaysH = split(x = msigdbr_df$entrez_gene, f = msigdbr_df$gs_name)

# run fgsea enrichment
length(pathwaysH)
pathwaysH[1]
fgseaRes <- fgsea(pathways=pathwaysH, geneList)
data.frame(fgseaRes)

```


## Quartils 
```{r}
## Creació del grup en funció dels quartils

quartiles <- quantile(matriu_exprs[gset@featureData@data$ID[gset@featureData@data$`Gene symbol`=="PLAC8"],])

matriu_exprs <- exprs(gset)

# S'ha de fer amb condicional 

expressio <- exprs(gset[gset@featureData@data$ID=="219014_at",])

gset@phenoData@data$gquantile<-rep(NA,dim(gset)[2])

for (i in 1:length(expressio)){
if(expressio[i]<=quartiles[[2]]){
  gset@phenoData@data$gquantile[i]<-"Q1"
  
}else if (expressio[i]>=quartiles[[4]]){
  gset@phenoData@data$gquantile[i]<-"Q4"}
  else{gset@phenoData@data$gquantile[i]<-"res"}}

# Expressió diferencial: grups Q1 vs Q4. 

# table(gset@phenoData@data$gquantile)
groups = gset@phenoData@data$gquantile
groups<-gsub("Q1","LOW",groups)
groups<-gsub("Q4","HIGH",groups)
groups<-as.factor(groups)

design = model.matrix(~ 0 + groups)
colnames(design)<-gsub("groups","",colnames(design))

data.fit = lmFit(matriu_exprs,design)

contrast.matrix = makeContrasts(LOW-HIGH,levels=design)
data.fit.con = contrasts.fit(data.fit,contrast.matrix)
data.fit.eb = eBayes(data.fit.con)

table_DEG_quartil <- topTable(data.fit.eb, number = Inf,adjust.method = "fdr",genelist = gset@featureData@data)

table_DEG_sig_quartil <-table_DEG_quartil %>% 
  filter(adj.P.Val<=0.05)
dim(table_DEG_sig_quartil)

save(table_DEG_quartil, file=paste0(resultatstaules_t, "/table_DEG_quartil"))
save(table_DEG_sig_quartil, file=paste0(resultatstaules_t, "/table_DEG_sig_quartil"))

```

Hi ha 662 gens diferencialment expressats significatius en teixit (separant l'expressió per quartils Q1 vs Q4)
```{r}
load(paste0(resultatstaules_t, "/table_DEG_sig_quartil"))

datatable_jm(table_DEG_sig_quartil, column = c("GO.Process", "GO.Function","GO.Process.ID", "GO.Function.ID"))

```


### GO GSEA
```{r }
library(org.Hs.eg.db)
library(clusterProfiler)

table_DEG_complete<-
  table_DEG_quartil[table_DEG_quartil$Gene.ID!="",]

table_DEG_complete<-
table_DEG_complete %>% group_by(Gene.ID) %>% 
  filter(adj.P.Val==min(adj.P.Val))
geneList<-table_DEG_complete$logFC
names(geneList)<-table_DEG_complete$Gene.ID

geneList<-geneList[order(geneList, decreasing = TRUE)]

set.seed(123)
GO_gsea <- gseGO(geneList     = geneList,
              OrgDb        = org.Hs.eg.db,
              ont          = "BP",
                # minGSSize    = 100,
                # maxGSSize    = 500,
              pvalueCutoff = 0.05,
              verbose      = T
              )

# GO_gsea
GO_gsea <- setReadable(GO_gsea, OrgDb = org.Hs.eg.db, keyType="ENTREZID")
save(GO_gsea,file = paste0(resultatsobjectes_t, "/GO_gsea"))

```


```{r}
load(paste0(resultatsobjectes_t, "/GO_gsea"))

# reducedTerms

GO_gsea_df<-GO_gsea@result
GO_gsea_df<-GO_gsea@result %>%
  filter(p.adjust<=0.05)


num_gens <-unlist(lapply(GO_gsea_df$core_enrichment, function(x) sum(table_DEG_complete$Gene.symbol%in%strsplit(x ,"/")[[1]]) ))
name_gens <-unlist(lapply(GO_gsea_df$core_enrichment, function(x) paste(table_DEG_complete$Gene.symbol[(table_DEG_complete$Gene.symbol%in%strsplit(x,"/")[[1]])],collapse = "/") ))

GO_gsea_df$num_gens<-num_gens
GO_gsea_df$name_gens<-name_gens

library(rrvgo)

simMatrix <- calculateSimMatrix(GO_gsea_df$ID,
                                orgdb="org.Hs.eg.db",
                                ont="BP",
                                method="Rel")

scores <- setNames(-log10(GO_gsea_df$qvalue), GO_gsea_df$ID)

reducedTerms_quartile <- reduceSimMatrix(simMatrix,
                                scores,
                                threshold=0.7,
                                orgdb="org.Hs.eg.db")


png(paste0(resultatsplots_t, "/treemapplot_quartile.png"),width = 900,height = 600,res=100)
treemapPlot(reducedTerms_quartile)
dev.off()
```


```{r}
knitr::include_graphics(paste0(resultatsplots_t, "/treemapplot_quartile.png"), dpi = 100)
```

### KEGG GSEA
```{r}
geneList<-table_DEG_complete$logFC
names(geneList)<-table_DEG_complete$Gene.ID

geneList<-geneList[order(geneList, decreasing = TRUE)]
set.seed(123)
kegg_gsea <- gseKEGG(geneList     = geneList,
               organism     = 'hsa',
               # minGSSize    = 120,
               pvalueCutoff = 0.05,
               verbose      = FALSE
               )

kegg_gsea <- setReadable(kegg_gsea, OrgDb = org.Hs.eg.db, keyType="ENTREZID")

save(kegg_gsea,file = paste0(resultatsobjectes_t, "/kegg_gsea_quartile"))
```


```{r}
load(paste0(resultatsobjectes_t, "/kegg_gsea_quartile"))

kegg_gsea_df<-kegg_gsea@result
kegg_gsea_df<-kegg_gsea@result %>%
  filter(p.adjust<=0.05) 

# kegg_gsea_df<-kegg_gsea_df[grepl(keys,kegg_gsea@result$Description,ignore.case = T),]

num_gens<-unlist(lapply(kegg_gsea_df$core_enrichment, function(x) sum(table_DEG_complete$Gene.symbol%in%strsplit(x ,"/")[[1]]) ))
name_gens<-unlist(lapply(kegg_gsea_df$core_enrichment, function(x) paste(table_DEG_complete$Gene.symbol[(table_DEG_complete$Gene.symbol%in%strsplit(x,"/")[[1]])],collapse = "/") ))

kegg_gsea_df$num_gens<-num_gens
kegg_gsea_df$name_gens<-name_gens

kegg_gsea_df<-
kegg_gsea_df %>% 
  mutate(NES_cat=ifelse(NES<0,"Down","Up"))

kegg_gsea_df_p<-kegg_gsea_df %>%
  arrange(NES) %>% 
  slice_head(n=20)

kegg_graph <- kegg_gsea_df_p %>% group_by(NES_cat) %>%
    slice_head(n=10) %>% 
    ggplot(aes(x = NES, y = fct_reorder(Description, NES))) + 
  geom_segment(aes(yend = Description,colour = p.adjust), xend = 0, size=3) +
  geom_point(aes(color = p.adjust),size = 5) +
    theme_bw(base_size = 15) +
  theme(text = element_text(size=12))+
    # scale_colour_gradient(limits=c(0, pvalue), low="red") +
    ylab(NULL)+
    # ggtitle(paste0("First ",num_GO, " up & ", num_GO," down regulated specific GO"))+
    facet_grid(.~NES_cat,scales = "free")+
  scale_colour_continuous(low = "#f29191",
                         high = "#4ca4fc")

kegg_gsea_df_quartile <- kegg_gsea_df

png(paste0(resultatsplots_t, "/kegg_graph_quantile.png"),width = 900,height = 600,res=100)
kegg_gsea_df_p %>% group_by(NES_cat) %>%
    slice_head(n=10) %>% 
    ggplot(aes(x = NES, y = fct_reorder(Description, NES))) + 
  geom_segment(aes(yend = Description,colour = p.adjust), xend = 0, size=3) +
  geom_point(aes(color = p.adjust),size = 5) +
    theme_bw(base_size = 15) +
  theme(text = element_text(size=12))+
    # scale_colour_gradient(limits=c(0, pvalue), low="red") +
    ylab(NULL)+
    # ggtitle(paste0("First ",num_GO, " up & ", num_GO," down regulated specific GO"))+
    facet_grid(.~NES_cat,scales = "free")+
  scale_colour_continuous(low = "#f29191",
                         high = "#4ca4fc")
dev.off()

save(kegg_gsea_df_quartile,file = paste0(resultatstaules_t, "/kegg_gsea_df_quartile"))

```

```{r}
load(paste0(resultatstaules_t, "/kegg_gsea_df_quartile"))

datatable_jm(kegg_gsea_df_quartile, column = c("core_enrichment"))


```

```{r}
knitr::include_graphics(paste0(resultatsplots_t, "/kegg_graph_quantile.png"), dpi = 100)
```


# 2. Anàlisi linia cel·lular


```{r echo=TRUE}
load(file = paste0(carpeta, "/gset"))

gset <- gset[,grep("line",gset@phenoData@data$characteristics_ch1)]
save(gset, file= paste0(resultatsobjectes_l,"/gset"))

```

# Normalització
Aquestes dades ja es troben normalitzades. 
No s'aplica cap normalització.
```{r eval=FALSE, include=TRUE}
# library(affyPLM)
# gset_norm<-normalize.ExpressionSet.quantiles(gset, transfn="none")

```

# Expressió de PLAC8
```{r}
matriu_exprs <- exprs(gset) 
boxplot(gset,las=2)

```

```{r}
# load("./RESULTATS_GSE17891/teixit/OBJECTES_R/gset")
# boxplot(gset, las=2)
```

# Expressió diferencial grups (high/low expression PLAC8)
Es realitza l'expressió diferencial en funció de la mediana o els quartils Q1 i Q4 de l'expressió de PLAC8 

## Median 
```{r}
library(clusterProfiler)
library(genefilter)
library(dplyr)
library(limma)

median <- median(matriu_exprs[gset@featureData@data$ID[gset@featureData@data$`Gene symbol`=="PLAC8"],])
# gset@featureData@data$ID[gset@featureData@data$`Gene symbol`=="PLAC8"]


gset@phenoData@data$gmedian <-
unlist(as.list(exprs(gset[gset@featureData@data$ID=="219014_at",])>median))

## Control vs Caso

# table(gset@phenoData@data$gmedian)
groups = gset@phenoData@data$gmedian
groups<-gsub("FALSE","LOW",groups)
groups<-gsub("TRUE","HIGH",groups)
groups<-as.factor(groups)

design = model.matrix(~ 0 + groups)
colnames(design)<-gsub("groups","",colnames(design))

data.fit = lmFit(matriu_exprs,design)

contrast.matrix = makeContrasts(LOW-HIGH,levels=design)
data.fit.con = contrasts.fit(data.fit,contrast.matrix)
data.fit.eb = eBayes(data.fit.con)

table_DEG_median <- topTable(data.fit.eb, number = Inf,adjust.method = "fdr",genelist = gset@featureData@data)

table_DEG_sig_median <- table_DEG_median %>%
                   filter(adj.P.Val<=0.05)

save(table_DEG_median, file= paste0(resultatstaules_l, "/table_DEG_median"))
save(table_DEG_sig_median, file= paste0(resultatstaules_l, "/table_DEG_sig_median"))

```

No hi ha gens diferencialment expressats que siguin signigicatius entre els dos grups (en funció de  median)
```{r}
dim(table_DEG_sig_median)
```


### GO_GSEA
```{r eval=FALSE}
load(paste0(resultatstaules_l, "/table_DEG_median"))

# GO GSEA

library(org.Hs.eg.db)
library(clusterProfiler)

table_DEG_complete<-
  table_DEG_median[table_DEG_median$Gene.ID!="",]

table_DEG_complete<-
table_DEG_complete %>% group_by(Gene.ID) %>% 
  filter(adj.P.Val==min(adj.P.Val))
geneList<-table_DEG_complete$logFC
names(geneList)<-table_DEG_complete$Gene.ID

save(table_DEG_complete, file = paste0(resultatstaules_l, "/table_DEG_complete"))

geneList<-geneList[order(geneList, decreasing = TRUE)]

set.seed(123)
GO_gsea <- gseGO(geneList     = geneList,
              OrgDb        = org.Hs.eg.db,
              ont          = "BP",
                # minGSSize    = 100,
                # maxGSSize    = 500,
              pvalueCutoff = 0.05,
              verbose      = T
              )

# GO_gsea
GO_gsea <- setReadable(GO_gsea, OrgDb = org.Hs.eg.db, keyType="ENTREZID")
save(GO_gsea,file = paste0(resultatsobjectes_l, "/GO_gsea"))
```


```{r}
load(paste0(resultatsobjectes_l, "/GO_gsea"))
load(paste0(resultatstaules_l, "/table_DEG_median"))
load(paste0(resultatstaules_l, "/table_DEG_complete"))


# reducedTerms

GO_gsea_df<-GO_gsea@result
GO_gsea_df<-GO_gsea@result %>%
  filter(p.adjust<=0.05)

num_gens <-unlist(lapply(GO_gsea_df$core_enrichment, function(x) sum(table_DEG_complete$Gene.symbol%in%strsplit(x ,"/")[[1]]) ))
name_gens <-unlist(lapply(GO_gsea_df$core_enrichment, function(x) paste(table_DEG_complete$Gene.symbol[(table_DEG_complete$Gene.symbol%in%strsplit(x,"/")[[1]])],collapse = "/") ))

GO_gsea_df$num_gens<-num_gens
GO_gsea_df$name_gens<-name_gens

library(rrvgo)

simMatrix <- calculateSimMatrix(GO_gsea_df$ID,
                                orgdb="org.Hs.eg.db",
                                ont="BP",
                                method="Rel")

scores <- setNames(-log10(GO_gsea_df$qvalue), GO_gsea_df$ID)

reducedTerms_median <- reduceSimMatrix(simMatrix,
                                scores,
                                threshold=0.7,
                                orgdb="org.Hs.eg.db")

png(paste0(resultatsplots_l, "/treemapplot_median.png"),width = 900,height = 600,res=100)
treemapPlot(reducedTerms_median)
dev.off()
```

```{r}
knitr::include_graphics(paste0(resultatsplots_l,"/treemapplot_median.png"), dpi = 100)
```

### KEGG GSEA
```{r}
load(paste0(resultatstaules_l, "/table_DEG_median"))
load(paste0(resultatstaules_l, "/table_DEG_complete"))


geneList<-table_DEG_complete$logFC
names(geneList)<-table_DEG_complete$Gene.ID

geneList<-geneList[order(geneList, decreasing = TRUE)]
set.seed(123)
kegg_gsea <- gseKEGG(geneList     = geneList,
               organism     = 'hsa',
               # minGSSize    = 120,
               pvalueCutoff = 0.05,
               verbose      = FALSE
               )

kegg_gsea <- setReadable(kegg_gsea, OrgDb = org.Hs.eg.db, keyType="ENTREZID")

save(kegg_gsea,file = paste0(resultatsobjectes_l, "/kegg_gsea_median"))
```


```{r}
load(paste0(resultatsobjectes_l, "/kegg_gsea_median"))
load(paste0(resultatstaules_l, "/table_DEG_median"))
load(paste0(resultatstaules_l, "/table_DEG_complete"))

kegg_gsea_df<-kegg_gsea@result
kegg_gsea_df<-kegg_gsea@result %>%
  filter(p.adjust<=0.05) 

num_gens<-unlist(lapply(kegg_gsea_df$core_enrichment, function(x) sum(table_DEG_complete$Gene.symbol%in%strsplit(x ,"/")[[1]]) ))
name_gens<-unlist(lapply(kegg_gsea_df$core_enrichment, function(x) paste(table_DEG_complete$Gene.symbol[(table_DEG_complete$Gene.symbol%in%strsplit(x,"/")[[1]])],collapse = "/") ))

kegg_gsea_df$num_gens<-num_gens
kegg_gsea_df$name_gens<-name_gens

kegg_gsea_df <-
kegg_gsea_df %>% 
  mutate(NES_cat=ifelse(NES<0,"Down","Up"))

kegg_gsea_df_p<-kegg_gsea_df %>%
  arrange(NES) %>% 
  slice_head(n=20)

kegg_graph <- kegg_gsea_df_p %>% group_by(NES_cat) %>%
    slice_head(n=10) %>% 
    ggplot(aes(x = NES, y = fct_reorder(Description, NES))) + 
  geom_segment(aes(yend = Description,colour = p.adjust), xend = 0, size=3) +
  geom_point(aes(color = p.adjust),size = 5) +
    theme_bw(base_size = 15) +
  theme(text = element_text(size=12))+
    # scale_colour_gradient(limits=c(0, pvalue), low="red") +
    ylab(NULL)+
    # ggtitle(paste0("First ",num_GO, " up & ", num_GO," down regulated specific GO"))+
    facet_grid(.~NES_cat,scales = "free")+
  scale_colour_continuous(low = "#f29191",
                         high = "#4ca4fc")

kegg_gsea_df_median <- kegg_gsea_df

save(kegg_gsea_df_median, file= paste0(resultatstaules_l, "/kegg_gsea_df_median"))

png(paste0(resultatsplots_l, "/kegg_graph_median.png"),width = 900,height = 600,res=100)
kegg_gsea_df_p %>% group_by(NES_cat) %>%
    slice_head(n=10) %>% 
    ggplot(aes(x = NES, y = fct_reorder(Description, NES))) + 
  geom_segment(aes(yend = Description,colour = p.adjust), xend = 0, size=3) +
  geom_point(aes(color = p.adjust),size = 5) +
    theme_bw(base_size = 15) +
  theme(text = element_text(size=12))+
    # scale_colour_gradient(limits=c(0, pvalue), low="red") +
    ylab(NULL)+
    # ggtitle(paste0("First ",num_GO, " up & ", num_GO," down regulated specific GO"))+
    facet_grid(.~NES_cat,scales = "free")+
  scale_colour_continuous(low = "#f29191",
                         high = "#4ca4fc")
dev.off()
```

```{r}

load(paste0(resultatstaules_l, "/kegg_gsea_df_median"))
datatable_jm(kegg_gsea_df_median, column = c("core_enrichment"))
```

```{r}
knitr::include_graphics(paste0(resultatsplots_l, "/kegg_graph_median.png"), dpi = 100)
```


## Quartils 
```{r}
## Creació del grup en funció dels quartils
matriu_exprs <- exprs(gset)
quartiles <- quantile(matriu_exprs[gset@featureData@data$ID[gset@featureData@data$`Gene symbol`=="PLAC8"],])

# S'ha de fer amb condicional 

expressio <- exprs(gset[gset@featureData@data$ID=="219014_at",])

gset@phenoData@data$gquantile<-rep(NA,dim(gset)[2])

for (i in 1:length(expressio)){
if(expressio[i]<=quartiles[[2]]){
  gset@phenoData@data$gquantile[i]<-"Q1"
  
}else if (expressio[i]>=quartiles[[4]]){
  gset@phenoData@data$gquantile[i]<-"Q4"}
  else{gset@phenoData@data$gquantile[i]<-"res"}}

# Expressió diferencial: grups Q1 vs Q4. 

# table(gset@phenoData@data$gquantile)
groups = gset@phenoData@data$gquantile
groups<-gsub("Q1","LOW",groups)
groups<-gsub("Q4","HIGH",groups)
groups<-as.factor(groups)

design = model.matrix(~ 0 + groups)
colnames(design)<-gsub("groups","",colnames(design))

data.fit = lmFit(matriu_exprs,design)

contrast.matrix = makeContrasts(LOW-HIGH,levels=design)
data.fit.con = contrasts.fit(data.fit,contrast.matrix)
data.fit.eb = eBayes(data.fit.con)

table_DEG_quartil <- topTable(data.fit.eb, number = Inf,adjust.method = "fdr",genelist = gset@featureData@data)

table_DEG_sig_quartil <-table_DEG_quartil %>% 
  filter(adj.P.Val<=0.05)
dim(table_DEG_sig_quartil)

save(table_DEG_quartil, file= paste0(resultatstaules_l, "/table_DEG_quartil"))
save(table_DEG_sig_quartil, file= paste0(resultatstaules_l, "/table_DEG_sig_quartil"))

```

Només hi ha un gen (PLAC8) diferencialment expressat significatiu (en funció de quartil)
```{r}
load(paste0(resultatstaules_l, "/table_DEG_sig_quartil"))

datatable_jm(table_DEG_sig_quartil, column = c("GO.Process", "GO.Function","GO.Process.ID", "GO.Function.ID"))

```


### GO GSEA
```{r}
library(org.Hs.eg.db)
library(clusterProfiler)

load(paste0(resultatstaules_l, "/table_DEG_quartil"))

table_DEG_complete<-
  table_DEG_quartil[table_DEG_quartil$Gene.ID!="",]

table_DEG_complete<-
table_DEG_complete %>% group_by(Gene.ID) %>% 
  filter(adj.P.Val==min(adj.P.Val))
geneList<-table_DEG_complete$logFC
names(geneList)<-table_DEG_complete$Gene.ID

save(table_DEG_complete, file= paste0(resultatstaules_l, "/table_DEG_complete_quartil"))

geneList<-geneList[order(geneList, decreasing = TRUE)]

set.seed(123)
GO_gsea <- gseGO(geneList     = geneList,
              OrgDb        = org.Hs.eg.db,
              ont          = "BP",
                # minGSSize    = 100,
                # maxGSSize    = 500,
              pvalueCutoff = 0.05,
              verbose      = T
              )

# GO_gsea
GO_gsea <- setReadable(GO_gsea, OrgDb = org.Hs.eg.db, keyType="ENTREZID")
save(GO_gsea,file = paste0(resultatsobjectes_l, "/GO_gsea_quartil"))
```


```{r}
load(paste0(resultatsobjectes_l, "/GO_gsea_quartil"))
load(paste0(resultatstaules_l, "/table_DEG_complete_quartil"))

# reducedTerms

GO_gsea_df<-GO_gsea@result
GO_gsea_df<-GO_gsea@result %>%
  filter(p.adjust<=0.05)


num_gens <-unlist(lapply(GO_gsea_df$core_enrichment, function(x) sum(table_DEG_complete$Gene.symbol%in%strsplit(x ,"/")[[1]]) ))
name_gens <-unlist(lapply(GO_gsea_df$core_enrichment, function(x) paste(table_DEG_complete$Gene.symbol[(table_DEG_complete$Gene.symbol%in%strsplit(x,"/")[[1]])],collapse = "/") ))

GO_gsea_df$num_gens<-num_gens
GO_gsea_df$name_gens<-name_gens

library(rrvgo)

simMatrix <- calculateSimMatrix(GO_gsea_df$ID,
                                orgdb="org.Hs.eg.db",
                                ont="BP",
                                method="Rel")

scores <- setNames(-log10(GO_gsea_df$qvalue), GO_gsea_df$ID)

reducedTerms_quartile <- reduceSimMatrix(simMatrix,
                                scores,
                                threshold=0.7,
                                orgdb="org.Hs.eg.db")


png(paste0(resultatsplots_l, "/treemapplot_quartile.png"),width = 900,height = 600,res=100)
treemapPlot(reducedTerms_quartile)
dev.off()
```

[actualitzat fins aqui 08/01]
```{r}
knitr::include_graphics(paste0(resultatsplots_l, "/treemapplot_quartile.png"), dpi = 100)
```

### KEGG GSEA
```{r}
load(paste0(resultatstaules_l, "/table_DEG_complete_quartil"))
geneList<-table_DEG_complete$logFC
names(geneList)<-table_DEG_complete$Gene.ID

geneList<-geneList[order(geneList, decreasing = TRUE)]
set.seed(123)
kegg_gsea <- gseKEGG(geneList     = geneList,
               organism     = 'hsa',
               # minGSSize    = 120,
               pvalueCutoff = 0.05,
               verbose      = FALSE
               )

kegg_gsea <- setReadable(kegg_gsea, OrgDb = org.Hs.eg.db, keyType="ENTREZID")

save(kegg_gsea,file = paste0(resultatsobjectes_l, "/kegg_gsea_quartile"))
```


```{r}
load(paste0(resultatsobjectes_l, "/kegg_gsea_quartile"))
load(paste0(resultatstaules_l, "/table_DEG_complete_quartil"))


kegg_gsea_df<-kegg_gsea@result
kegg_gsea_df<-kegg_gsea@result %>%
  filter(p.adjust<=0.05) 

# kegg_gsea_df<-kegg_gsea_df[grepl(keys,kegg_gsea@result$Description,ignore.case = T),]

num_gens<-unlist(lapply(kegg_gsea_df$core_enrichment, function(x) sum(table_DEG_complete$Gene.symbol%in%strsplit(x ,"/")[[1]]) ))
name_gens<-unlist(lapply(kegg_gsea_df$core_enrichment, function(x) paste(table_DEG_complete$Gene.symbol[(table_DEG_complete$Gene.symbol%in%strsplit(x,"/")[[1]])],collapse = "/") ))

kegg_gsea_df$num_gens<-num_gens
kegg_gsea_df$name_gens<-name_gens

kegg_gsea_df<-
kegg_gsea_df %>% 
  mutate(NES_cat=ifelse(NES<0,"Down","Up"))

kegg_gsea_df_p<-kegg_gsea_df %>%
  arrange(NES) %>% 
  slice_head(n=20)

kegg_graph <- kegg_gsea_df_p %>% group_by(NES_cat) %>%
    slice_head(n=10) %>% 
    ggplot(aes(x = NES, y = fct_reorder(Description, NES))) + 
  geom_segment(aes(yend = Description,colour = p.adjust), xend = 0, size=3) +
  geom_point(aes(color = p.adjust),size = 5) +
    theme_bw(base_size = 15) +
  theme(text = element_text(size=12))+
    # scale_colour_gradient(limits=c(0, pvalue), low="red") +
    ylab(NULL)+
    # ggtitle(paste0("First ",num_GO, " up & ", num_GO," down regulated specific GO"))+
    facet_grid(.~NES_cat,scales = "free")+
  scale_colour_continuous(low = "#f29191",
                         high = "#4ca4fc")

kegg_gsea_df_quartile <- kegg_gsea_df

png(paste0(resultatsplots_l, "/kegg_graph_quantile.png"),width = 900,height = 600,res=100)
kegg_gsea_df_p %>% group_by(NES_cat) %>%
    slice_head(n=10) %>% 
    ggplot(aes(x = NES, y = fct_reorder(Description, NES))) + 
  geom_segment(aes(yend = Description,colour = p.adjust), xend = 0, size=3) +
  geom_point(aes(color = p.adjust),size = 5) +
    theme_bw(base_size = 15) +
  theme(text = element_text(size=12))+
    # scale_colour_gradient(limits=c(0, pvalue), low="red") +
    ylab(NULL)+
    # ggtitle(paste0("First ",num_GO, " up & ", num_GO," down regulated specific GO"))+
    facet_grid(.~NES_cat,scales = "free")+
  scale_colour_continuous(low = "#f29191",
                         high = "#4ca4fc")
dev.off()

# datatable_mod4(kegg_gsea_df_quartile,col_inv="core_enrichment")

save(kegg_gsea_df_quartile,file = paste0(resultatstaules_l, "/kegg_gsea_df_quartile"))

```

```{r}
load(paste0(resultatstaules_l, "/kegg_gsea_df_quartile"))

datatable_jm(kegg_gsea_df_quartile, column = c("core_enrichment"))


```

```{r}
knitr::include_graphics(paste0(resultatsplots_l, "/kegg_graph_quantile.png"), dpi = 100)
```

